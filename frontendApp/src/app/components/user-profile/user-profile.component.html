<ion-header>
  <ion-toolbar color="primary">
    <ion-title>User Profile</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="profile-container" *ngIf="user">
    <!-- User Info Card -->
    <ion-card class="user-info-card">
      <ion-card-header>
        <div class="user-avatar">
          <ion-icon name="person-circle" class="avatar-icon"></ion-icon>
        </div>
        <ion-card-title>{{ user.full_name }}</ion-card-title>
        <ion-card-subtitle>{{ user.username }}</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <ion-list lines="none">
          <!-- Email -->
          <ion-item>
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Email</p>
              <h3>{{ user.email }}</h3>
            </ion-label>
          </ion-item>

          <!-- Role -->
          <ion-item>
            <ion-icon name="shield-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Role</p>
              <h3>{{ user.role | titlecase }}</h3>
            </ion-label>
            <ion-badge [color]="user.role === 'admin' ? 'danger' : 'primary'" slot="end">
              {{ user.role | uppercase }}
            </ion-badge>
          </ion-item>

          <!-- Account Status -->
          <ion-item>
            <ion-icon name="information-circle-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Account Status</p>
              <h3>{{ user.is_active ? 'Active' : 'Inactive' }}</h3>
            </ion-label>
            <ion-badge [color]="user.is_active ? 'success' : 'danger'" slot="end">
              {{ user.is_active ? 'ACTIVE' : 'INACTIVE' }}
            </ion-badge>
          </ion-item>

          <!-- Last Login -->
          <ion-item>
            <ion-icon name="time-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Last Login</p>
              <h3>{{ getFormattedDate(user.last_login) }}</h3>
            </ion-label>
          </ion-item>

          <!-- Member Since -->
          <ion-item>
            <ion-icon name="calendar-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Member Since</p>
              <h3>{{ getFormattedDate(user.created_at) }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Change Password Section -->
    <ion-card class="action-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="key-outline"></ion-icon>
          Security
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-button
          expand="block"
          fill="outline"
          (click)="toggleChangePassword()"
          [color]="showChangePassword ? 'medium' : 'primary'"
        >
          <ion-icon [name]="showChangePassword ? 'chevron-up-outline' : 'lock-closed-outline'" slot="start"></ion-icon>
          {{ showChangePassword ? 'Cancel' : 'Change Password' }}
        </ion-button>

        <!-- Change Password Form -->
        <div class="change-password-form" *ngIf="showChangePassword">
          <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
            <!-- Current Password -->
            <ion-item class="input-item" lines="none">
              <ion-input
                fill="outline"
                label="Current Password"
                labelPlacement="floating"
                formControlName="currentPassword"
                type="password"
                autocomplete="current-password"
              >
                <ion-input-password-toggle slot="end"></ion-input-password-toggle>
              </ion-input>
            </ion-item>

            <!-- New Password -->
            <ion-item class="input-item" lines="none">
              <ion-input
                fill="outline"
                label="New Password"
                labelPlacement="floating"
                formControlName="newPassword"
                type="password"
                autocomplete="new-password"
              >
                <ion-input-password-toggle slot="end"></ion-input-password-toggle>
              </ion-input>
            </ion-item>

            <!-- Confirm New Password -->
            <ion-item class="input-item" lines="none">
              <ion-input
                fill="outline"
                label="Confirm New Password"
                labelPlacement="floating"
                formControlName="confirmPassword"
                type="password"
                autocomplete="new-password"
              >
                <ion-input-password-toggle slot="end"></ion-input-password-toggle>
              </ion-input>
            </ion-item>

            <ion-button
              expand="block"
              type="submit"
              [disabled]="loading || changePasswordForm.invalid"
              class="submit-btn"
            >
              <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
              <span *ngIf="!loading">Update Password</span>
            </ion-button>
          </form>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Credentials Management Section -->
    <ion-card class="action-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="key"></ion-icon>
          Credentials
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-button
          expand="block"
          fill="outline"
          (click)="toggleCredentials()"
          [color]="showCredentials ? 'medium' : 'tertiary'"
        >
          <ion-icon [name]="showCredentials ? 'chevron-up-outline' : 'key-outline'" slot="start"></ion-icon>
          {{ showCredentials ? 'Hide Credentials' : 'Manage Credentials' }}
        </ion-button>

        <!-- Credentials Management Content -->
        <div class="credentials-section" *ngIf="showCredentials">

          <!-- Add New Credential Form -->
          <h4>Add New Credential</h4>
          <div class="add-credential-form">

            <form [formGroup]="credentialForm" (ngSubmit)="addCredential()">
              <ion-item class="input-item" lines="none">
                <ion-input
                  fill="outline"
                  label="Key"
                  labelPlacement="floating"
                  formControlName="credentialKey"
                  placeholder="e.g. api_key, database_url"
                ></ion-input>
              </ion-item>

              <ion-item class="input-item" lines="none">
                <ion-input
                  fill="outline"
                  label="Value"
                  labelPlacement="floating"
                  formControlName="credentialValue"
                  type="password"
                  placeholder="Enter credential value"
                >
                  <ion-input-password-toggle slot="end"></ion-input-password-toggle>
                </ion-input>
              </ion-item>

              <ion-button
                expand="block"
                type="submit"
                [disabled]="loading || credentialForm.invalid"
                color="primary"
                class="add-credential-btn"
              >
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Add Credential
              </ion-button>
            </form>
          </div>

          <!-- Existing Credentials List -->
          <div class="credentials-list" *ngIf="getCredentials().length > 0">
            <h4>Existing Credentials</h4>

            <ion-list class="credentials-ion-list">
              <ion-item *ngFor="let credential of getCredentials()" class="credential-item">
                <ion-icon name="key-outline" slot="start"></ion-icon>

                <ion-label class="credential-label">
                  <h3>{{ credential.key }}</h3>

                  <!-- Display mode -->
                  <div *ngIf="editingCredential !== credential.key" class="credential-display">
                    <ion-item lines="none" class="display-input-item">
                      <ion-input
                        label="Value"
                        labelPlacement="floating"
                        [value]="credential.value"
                        type="password"
                        readonly
                      >
                        <ion-input-password-toggle slot="end"></ion-input-password-toggle>
                      </ion-input>
                    </ion-item>
                  </div>

                  <!-- Edit mode -->
                  <div *ngIf="editingCredential === credential.key" class="credential-edit">
                    <ion-item lines="none" class="edit-input-item">
                      <ion-input
                        fill="outline"
                        label="Value"
                        labelPlacement="floating"
                        [(ngModel)]="editCredentialValue"
                        type="password"
                      >
                        <ion-input-password-toggle slot="end"></ion-input-password-toggle>
                      </ion-input>
                    </ion-item>

                    <div class="edit-actions">
                      <ion-button
                        fill="clear"
                        size="small"
                        (click)="cancelEditCredential()"
                        color="medium"
                      >
                        <ion-icon name="close-outline" slot="start"></ion-icon>
                        Cancel
                      </ion-button>
                      <ion-button
                        fill="clear"
                        size="small"
                        (click)="saveEditedCredential()"
                        color="primary"
                        [disabled]="!editCredentialValue.trim()"
                      >
                        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                        Save
                      </ion-button>
                    </div>
                  </div>
                </ion-label>

                <div slot="end" class="credential-actions" *ngIf="editingCredential !== credential.key">
                  <ion-button
                    fill="clear"
                    size="small"
                    (click)="startEditCredential(credential.key)"
                  >
                    <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="deleteCredential(credential.key)"
                  >
                    <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              </ion-item>
            </ion-list>
          </div>

          <!-- Empty state -->
          <div class="empty-credentials" *ngIf="getCredentials().length === 0">
            <ion-text color="medium">
              <p>No credentials configured yet.</p>
            </ion-text>
          </div>

        </div>
      </ion-card-content>
    </ion-card>

    <!-- Admin User Management Section -->
    <ion-card class="action-card" *ngIf="isAdmin()">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="people-outline"></ion-icon>
          User Management
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ion-button
          expand="block"
          fill="outline"
          (click)="toggleUserManagement()"
          [color]="showUserManagement ? 'medium' : 'secondary'"
        >
          <ion-icon [name]="showUserManagement ? 'chevron-up-outline' : 'people-outline'" slot="start"></ion-icon>
          {{ showUserManagement ? 'Hide Users' : 'Manage Users' }}
        </ion-button>

        <!-- User Management Content -->
        <div class="user-management-section" *ngIf="showUserManagement">
          <!-- Create New User Button -->
          <ion-button
            expand="block"
            color="primary"
            (click)="createNewUser()"
            class="create-user-btn"
          >
            <ion-icon name="person-add-outline" slot="start"></ion-icon>
            Create New User
          </ion-button>

          <!-- Loading State -->
          <div class="loading-users" *ngIf="loadingUsers">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading users...</p>
          </div>

          <!-- Users List -->
          <div class="users-list" *ngIf="!loadingUsers && allUsers.length > 0">
            <ion-card *ngFor="let managedUser of allUsers" class="user-item-card">
              <ion-card-content>
                <div class="user-item-header">
                  <div class="user-info">
                    <ion-icon name="person-circle-outline" class="user-icon"></ion-icon>
                    <div class="user-details">
                      <h3>{{ managedUser.full_name }}</h3>
                      <p class="username">{{ '@' + managedUser.username }}</p>
                      <p class="email">{{ managedUser.email }}</p>
                    </div>
                  </div>
                  <div class="user-badges">
                    <ion-badge [color]="managedUser.role === 'admin' ? 'danger' : 'primary'">
                      {{ managedUser.role | uppercase }}
                    </ion-badge>
                    <ion-badge [color]="managedUser.is_active ? 'success' : 'warning'">
                      {{ managedUser.is_active ? 'ACTIVE' : 'INACTIVE' }}
                    </ion-badge>
                  </div>
                </div>

                <div class="user-meta">
                  <p>
                    <ion-icon name="calendar-outline"></ion-icon>
                    Joined: {{ getFormattedDate(managedUser.created_at) }}
                  </p>
                  <p>
                    <ion-icon name="time-outline"></ion-icon>
                    Last login: {{ getFormattedDate(managedUser.last_login) }}
                  </p>
                </div>

                <!-- Action Buttons -->
                <div class="user-actions" *ngIf="managedUser.id !== user.id">
                  <ion-button
                    size="small"
                    fill="outline"
                    [color]="managedUser.is_active ? 'warning' : 'success'"
                    (click)="managedUser.is_active ? deactivateUser(managedUser) : activateUser(managedUser)"
                  >
                    <ion-icon
                      [name]="managedUser.is_active ? 'eye-off-outline' : 'eye-outline'"
                      slot="start"
                    ></ion-icon>
                    {{ managedUser.is_active ? 'Deactivate' : 'Activate' }}
                  </ion-button>

                  <ion-button
                    size="small"
                    fill="outline"
                    color="secondary"
                    (click)="changeUserPassword(managedUser)"
                  >
                    <ion-icon name="key-outline" slot="start"></ion-icon>
                    Change Password
                  </ion-button>

                  <ion-button
                    size="small"
                    fill="outline"
                    color="danger"
                    (click)="deleteUser(managedUser)"
                  >
                    <ion-icon name="trash-outline" slot="start"></ion-icon>
                    Delete
                  </ion-button>
                </div>

                <!-- Can't modify self -->
                <div class="user-actions" *ngIf="managedUser.id === user.id">
                  <ion-note color="medium">
                    <ion-icon name="lock-closed-outline"></ion-icon>
                    You cannot modify your own account from here
                  </ion-note>
                </div>
              </ion-card-content>
            </ion-card>
          </div>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="!loadingUsers && allUsers.length === 0">
            <ion-icon name="people-outline" class="empty-icon"></ion-icon>
            <p>No users found</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Actions Card -->
    <ion-card class="action-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="settings-outline"></ion-icon>
          Account Actions
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <!-- Logout Button -->
        <ion-button
          expand="block"
          color="medium"
          (click)="onLogout()"
          class="action-btn"
        >
          <ion-icon name="log-out-outline" slot="start"></ion-icon>
          Logout
        </ion-button>

        <!-- Deactivate Account Button -->
        <ion-button
          expand="block"
          color="danger"
          fill="outline"
          (click)="onDeactivateAccount()"
          class="action-btn"
        >
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          Deactivate Account
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="!user">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading user profile...</p>
  </div>
</ion-content>

