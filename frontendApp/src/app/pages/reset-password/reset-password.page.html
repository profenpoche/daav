<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Reset Password</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="reset-password-container">
    <!-- Invalid Token View -->
    <div *ngIf="!tokenValid" class="invalid-token-view">
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      <h1>Invalid or Expired Link</h1>
      <p class="error-message">
        This password reset link is invalid or has expired.
        Password reset links are only valid for 1 hour.
      </p>
      <ion-button
        expand="block"
        (click)="goToForgotPassword()"
        class="action-btn"
      >
        <ion-icon name="mail-outline" slot="start"></ion-icon>
        Request New Link
      </ion-button>
      <ion-button
        expand="block"
        fill="outline"
        (click)="goToLogin()"
        class="secondary-btn"
      >
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Back to Login
      </ion-button>
    </div>

    <!-- Valid Token - Reset Form -->
    <div *ngIf="tokenValid" class="reset-form-view">
      <div class="header-section">
        <ion-icon name="key" class="header-icon"></ion-icon>
        <h1>Create New Password</h1>
        <p class="subtitle">
          Enter your new password below. Make sure it's strong and secure.
        </p>
      </div>

      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" class="reset-password-form">
        <!-- Password Field -->
        <ion-item class="input-item" lines="none">
          <ion-input
            fill="outline"
            label="New Password"
            labelPlacement="floating"
            formControlName="password"
            type="password"
            placeholder="Enter your new password"
            autocomplete="new-password"
            [class.invalid]="resetPasswordForm.get('password')?.touched && resetPasswordForm.get('password')?.invalid"
          >
            <ion-icon name="lock-closed-outline" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
            <ion-input-password-toggle slot="end"></ion-input-password-toggle>
          </ion-input>
        </ion-item>
        <div class="error-message" *ngIf="getFieldError('password')">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <span>{{ getFieldError('password') }}</span>
        </div>

        <!-- Password Strength Indicator -->
        <div class="password-requirements" *ngIf="resetPasswordForm.get('password')?.touched">
          <p class="requirements-title">Password must contain:</p>
          <ul class="requirements-list">
            <li [class.met]="!getPasswordStrengthErrors().includes('one uppercase letter')">
              <ion-icon [name]="!getPasswordStrengthErrors().includes('one uppercase letter') ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              At least one uppercase letter
            </li>
            <li [class.met]="!getPasswordStrengthErrors().includes('one lowercase letter')">
              <ion-icon [name]="!getPasswordStrengthErrors().includes('one lowercase letter') ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              At least one lowercase letter
            </li>
            <li [class.met]="!getPasswordStrengthErrors().includes('one number')">
              <ion-icon [name]="!getPasswordStrengthErrors().includes('one number') ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              At least one number
            </li>
            <li [class.met]="!getPasswordStrengthErrors().includes('one special character')">
              <ion-icon [name]="!getPasswordStrengthErrors().includes('one special character') ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              At least one special character
            </li>
            <li [class.met]="resetPasswordForm.get('password')?.value?.length >= 8">
              <ion-icon [name]="resetPasswordForm.get('password')?.value?.length >= 8 ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              At least 8 characters long
            </li>
          </ul>
        </div>

        <!-- Confirm Password Field -->
        <ion-item class="input-item" lines="none">
          <ion-input
            fill="outline"
            label="Confirm New Password"
            labelPlacement="floating"
            formControlName="confirmPassword"
            type="password"
            placeholder="Re-enter your new password"
            autocomplete="new-password"
            [class.invalid]="resetPasswordForm.get('confirmPassword')?.touched && (resetPasswordForm.get('confirmPassword')?.invalid || resetPasswordForm.errors?.['passwordMismatch'])"
          >
            <ion-icon name="lock-closed-outline" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
            <ion-input-password-toggle slot="end"></ion-input-password-toggle>
          </ion-input>
        </ion-item>
        <div class="error-message" *ngIf="getFieldError('confirmPassword')">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <span>{{ getFieldError('confirmPassword') }}</span>
        </div>

        <!-- Submit Button -->
        <ion-button
          expand="block"
          type="submit"
          [disabled]="loading"
          class="submit-btn"
        >
          <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
          <span *ngIf="!loading">Reset Password</span>
        </ion-button>

        <!-- Cancel Link -->
        <div class="cancel-link">
          <ion-button
            expand="block"
            fill="clear"
            (click)="goToLogin()"
            type="button"
          >
            <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
            Back to Login
          </ion-button>
        </div>
      </form>
    </div>
  </div>
</ion-content>
